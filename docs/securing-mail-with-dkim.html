<!DOCTYPE html>
<html lang="en">
    <head>
	<meta charset="utf-8">
	<title>Securing mail using DKIM - Tech, tales and imagery</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="Tech, tales and imagery" property="og:site_name">
  
    <meta content="Securing mail using DKIM" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="A technical blog" property="og:description">
  
  
    <meta content="https://cullaloe.com/securing-mail-with-dkim" property="og:url">
  
  
    <meta content="2020-06-01T00:00:00+01:00" property="article:published_time">
    <meta content="https://cullaloe.com/about/" property="article:author">
  
  
    <meta content="https://cullaloe.com/assets/img/R0000416.jpg" property="og:image">
  
  
    
  
  
    
    <meta content="Plesk" property="article:tag">
    
    <meta content="DNS" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@Niximagery">
    <meta name="twitter:creator" content="@NixImagery">
  
    <meta name="twitter:title" content="Securing mail using DKIM">
  
  
    <meta name="twitter:url" content="https://cullaloe.com/securing-mail-with-dkim">
  
  
    <meta name="twitter:description" content="A technical blog">
  
  
    <meta name="twitter:image:src" content="https://cullaloe.com/assets/img/R0000416.jpg">
  

	<meta name="description" content="">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicon/apple-touch-icon-144x144.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/fontawesome.min.css">
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/brands.min.css">
  <!-- Academicons -->
  <link rel="stylesheet" href="/assets/fonts/academicons/css/academicons.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/search.css">

  <link rel="me" href="https://mastodon.scot/@niximagery">



<!-- Buy me a coffee -->
<script data-name="BMC-Widget" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="cullaloe" data-description="Helpful? Buy me a coffee!" data-message="" data-color="#5F7FFF" data-position="right" data-x_margin="18" data-y_margin="18"></script>
<!-- /Buy me a coffee -->

</head>

<body>

  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <p>cullaloe.com<br/>Tech, tales and imagery</p>
      <div class="cover-author-image">
        <a href="/"><img src="/assets/img/nick-hood.jpg" alt="Nick Hood"></a>
      </div>
      <!-- <div class="author-name">by <a href="/about" target="_self" class="plain">Nick Hood</a></div> -->
      <div class="search" id="js-search">
        <input type="text" placeholder="type to search..." class="search__input" id="js-search__input">
      </div>
    </div>
    <ul class="search__results" id="js-search__results"></ul>
</header> <!-- End Header -->

  <footer>
    <section class="contact">
      <h3 class="contact-title">Navigate</h3>
      <ul>
        <li><a href="/" target="_self" title="Home"><i class="fa fa-home" aria-hidden="true"></i></a></li>
        <li><a href="/about" target="_self" title="About"><i class="fa fa-info" aria-hidden="true"></i></a></li>
        <li><a href="/tags" target="_self" title="Tags and Topics"><i class="fa fa-tags" aria-hidden="true"></i></a></li>
        <li><a href="//static.cullaloe.net/Research" target="_blank" title="My research diary (login required)"><i class="fa fa-mortar-board" aria-hidden="true"></i></a></li>
        <li><a href="/feed.xml" target="_blank" title="RSS XML feed"><i class="fa fa-rss" aria-hidden="true"></i></a></li>
      </ul>
    </section> <!-- End Section links -->
    <section class="contact">
      <h3 class="contact-title">Connect</h3>
      <ul>
        
        <li><a href="https://orcid.org/0000-0001-7891-9736" target="_blank"><i class="ai ai-orcid-square" aria-hidden="true"></i></a></li>
        
        
        <li class="github"><a href="http://github.com/NixImagery" target="_blank"><i class="fab fa-github"></i></a></li>
        
        
        <li><a href="https://www.researchgate.net/profile/Nick-Hood" target="_blank"><i class="ai ai-researchgate" aria-hidden="true"></i></a></li>
        
        
        <li class="linkedin"><a href="https://in.linkedin.com/in/Niximagery" target="_blank"><i class="fab fa-linkedin"></i></a></li>
        
        
        <li><a href="https://facebook.com/NixImagery" target="_blank"><i class="fab fa-facebook" aria-hidden="true"></i></a></li>
        
        
        <li><a href="https://instagram.com/NixImagery" target="_blank"><i class="fab fa-instagram" aria-hidden="true"></i></a></li>
        
        
          <li><a href="https://mastodon.scot/@NixImagery" target="_blank"><i class="fab fa-mastodon" aria-hidden="true"></i></a></li>
        
        
          <li><a href="https://twitter.com/NixImagery" target="_blank"><i class="fab fa-twitter" aria-hidden="true"></i></a></li>
        
        
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2023 &copy; Nick Hood</p>
      <hr>Worried about online abuse? <a href="https://www.ceop.police.uk/safety-centre/">Report it to CEOP</a>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->

<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    
    <div class="page-cover-image">
      <figure>
        <img class="page-image" src=/assets/img/R0000416.jpg alt="Securing mail using DKIM">
        
          <figcaption>Durham
            
              <br/><div class="attrib">Nick Hood</div>
            
          </figcaption>
        
      </figure>
    </div> <!-- End Page Cover Image -->
    
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">Securing mail using DKIM</h1>
        <div class="page-date"><span>2020, Jun 01&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <p>Over the weekend, as I was updating DNS tables for a client, I thought I’d sharpen up my server mail settings to make the mail service more robust. I’ve seen (unrelated to this) an increase in spam recently and it had been on my mind to do more to combat it. These notes set out broadly how I configure my mail server.</p>

<h2 id="mail-server-settings">Mail server settings</h2>
<p>The mail server I use is Postfix/Dovecot. Using the Plesk control interface on my VPS<sup id="fnref:vps" role="doc-noteref"><a href="#fn:vps" class="footnote" rel="footnote">1</a></sup>, there are a number of settings needed to mitigate the scourge that is spam emails. From Tools &amp; Settings, select Server-wide mail settings make these changes.</p>

<h3 id="using-dns-blacklisting">Using DNS Blacklisting</h3>
<p>The first thing to do is to switch on spam protection based on DNS blackhole lists such as <a href="https://www.spamhaus.org/">zen.spamhaus.org</a>, <a href="https://abuse.ch/">spam.abuse.ch</a> and <a href="https://imp.ch/">spamrbl.imp.ch</a>. Also, when you do get spam in your inbox, report it immediately. This means just copying the message source<sup id="fnref:notthat" role="doc-noteref"><a href="#fn:notthat" class="footnote" rel="footnote">2</a></sup> into a form at somewhere like <a href="https://www.spamcop.net/">SpamCop.net</a>, who will send abuse reports to the ISPs that allow the spammers access to the internet. What we hope is that these providers will shut them down, but some are repeat offenders: all of my recent reports have gone to <a href="https://www.cloudflare.com/">CloudFlare</a> who seem reluctant to combat internet abuse, perhaps because they are making money out of it.</p>

<h2 id="spf">SPF</h2>
<p><a href="https://www.rfc-editor.org/info/rfc7208">Sender Policy Framework</a> is designed to allow domain admins to authorise the servers that are allowed to use their domain names. Receiving mail servers can check that authorisation by looking up the SPF record of the domain claimed in the “from” field of an email.</p>

<p>Within the Plesk panel for the mail server, under <code class="language-plaintext highlighter-rouge">SPF spam protection</code>, check <code class="language-plaintext highlighter-rouge">Enable SPF spam protection to check incoming mail</code> and select <code class="language-plaintext highlighter-rouge">Only create Received-SPF headers, never block</code> from the drop-down. Your domains should also have an SPF code in the DNS table. This acts like a return address on a snail-mail envelope. Servers can check the sender’s IP against this DNS record to check that it is allowed to send mail on behalf of the domain. This record identifies the version of SPF being used (always 1 at the moment), which records pertain and what policy should be applied to mail that fails to be verified when this record is checked by the receiving mail server. <code class="language-plaintext highlighter-rouge">-a</code> is a hard fail setting which advises rejection of mail that doesn’t match the record parameters. <code class="language-plaintext highlighter-rouge">~a</code> is a soft fail, and <code class="language-plaintext highlighter-rouge">+a</code> is like leaving your keys in the front door. Use the hard fail setting.</p>

<h2 id="dkim">DKIM</h2>
<p><a href="https://www.rfc-editor.org/info/rfc6376">DomainKeys Identified Mail (DKIM)</a> is a system that allows the mail server to “certify” emails to assert their authenticity. This is achieved through a cryptographic signature and by querying the signer’s domain directly to retrieve a key. This requires another couple of entries in the DNS table to contain the keys (see table below for examples). Take care when entering your key that you do not inadvertently introduce spaces in the long key. They will invalidate your key.</p>

<p>To enable this on the VPS, in the server-wide mail settings interface in Plesk, check <code class="language-plaintext highlighter-rouge">Verify incoming mail</code> and <code class="language-plaintext highlighter-rouge">Allow signing outgoing mail</code> under DKIM spam protection. In the panel for each subscription (domain), in the Mail Settings tab, check <code class="language-plaintext highlighter-rouge">Use DKIM spam protection system to sign outgoing email messages</code>.</p>

<h2 id="dmarc">DMARC</h2>
<p>Bringing the measures together, with a DNS-based reporting mechanism that closes the loop, is <a href="https://www.rfc-editor.org/info/rfc7489">Domain-based Message Authentication, Reporting, and Conformance (DMARC)</a>. This helps protect the domain from unauthorized use. It also requires a DNS TXT entry which identifies policy for handling non-aligned (mail that looks like it might be spam) emails, and a place to send reports about incidents. Setting up needs the policy to be passive, or “reporting only”, set by <code class="language-plaintext highlighter-rouge">p-none</code> in the DNS record. Increasing levels of confidence in the deliverability of email from the server allows organisations to increase this policy to “quarantine”, or even “reject”. Email reports are sent for authentication failure (forensic) and summary information (aggregate) to the email addresses in the record.</p>

<p>If you want to send your DMARC reports to an address at a different domain, then that domain needs a DNS record to authorize the the reports:</p>

<p><code class="language-plaintext highlighter-rouge">reportingdomain.tld._report._dmarc TXT v=DMARC1</code></p>

<p>If the target domain for the reports is being used for several domains (as in my case), then you can specify a wildcard entry:</p>

<p><code class="language-plaintext highlighter-rouge">*._report._dmarc TXT v=DMARC1</code></p>

<p>Within the Plesk server-wide mail settings panel, you can now check <code class="language-plaintext highlighter-rouge">Enable DMARC to check incoming mail</code>.</p>

<h2 id="summary">Summary</h2>
<p>The final DNS aligns with the server settings to provide a more robust and spam-free<sup id="fnref:orly" role="doc-noteref"><a href="#fn:orly" class="footnote" rel="footnote">3</a></sup> mail experience. An example DNS set of mail-related TXT entries:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Host name</th>
      <th style="text-align: left">Record type</th>
      <th style="text-align: left">Address</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">@</td>
      <td style="text-align: left">TXT</td>
      <td style="text-align: left">v=spf1 +a +mx -all</td>
    </tr>
    <tr>
      <td style="text-align: left">_domainkey</td>
      <td style="text-align: left">TXT</td>
      <td style="text-align: left">o=-</td>
    </tr>
    <tr>
      <td style="text-align: left">default._domainkey</td>
      <td style="text-align: left">TXT</td>
      <td style="text-align: left">v=DKIM1;k=rsa; p=yourkeygoeshere</td>
    </tr>
    <tr>
      <td style="text-align: left">_dmarc</td>
      <td style="text-align: left">TXT</td>
      <td style="text-align: left">v=DMARC1; p=none; rua=mailto:aggregate@yourdomain.tld; ruf=mailto:forensics@yourdomain.tld; fo=1</td>
    </tr>
  </tbody>
</table>

<p>Thanks to <a href="https://mxtoolbox.com/">mxtoolbox</a> for providing a suite of extremely useful tools and information. Although there is <a href="https://ietf.org/standards/rfcs/">RFC</a>, this would have been much harder to do without your help. Most of the DKIM verifiers out there don’t actually check the validity of the signature key: <a href="https://www.dmarcanalyzer.com/">DMARCAnalyzer</a> does, thanks also to them for this service.</p>

<h2 id="notes">Notes</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:vps" role="doc-endnote">
      <p>Virtual private server. Literally, a Dell server, in a rack, connected to the T1 backbone in London. Mine runs Centos, a variant of RedHat specifically designed for this kind of job. My ISP for the past 20 years has been <a href="https://hostinguk.net/">Hosting UK</a>, run by Phil Parry, who set the business up in his garage. It’s now part of the Scottish IT business <a href="https://www.iomart.com/">IoMart</a>. <a href="#fnref:vps" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:notthat" role="doc-endnote">
      <p>Not the body of the email. The DNS blacklisters need to see the contents of the email header, which reveals where it came from and how it was routed to your computer. Filter scores are also included here. On a mac, if you’re using Mail.app, just click in the body of the mail message and click cmd-alt-u to get a pop-up with the email message source. Cmd-a, cmd-c, and then paste it in the textbox on the spamcop form. <a href="#fnref:notthat" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:orly" role="doc-endnote">
      <p>Well, we will see how it goes. <a href="#fnref:orly" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

      <div class="page-footer">
        <div class="page-share">Share this post on 
          <a href="https://twitter.com/intent/tweet?text=Securing mail using DKIM&url=https://cullaloe.com/securing-mail-with-dkim" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a> or 
          <a href="https://facebook.com/sharer.php?u=https://cullaloe.com/securing-mail-with-dkim" title="Share on Facebook" rel="nofollow" target="_blank">Facebook</a>, or maybe 
          <a target="_blank" href="https://www.buymeacoffee.com/cullaloe">Buy me a coffee</a>
        </div>
        <div class="page-tag">
          
            <a href="/tags#Plesk" class="tag">&#35; Plesk</a>
          
            <a href="/tags#DNS" class="tag">&#35; DNS</a>
          
        </div>
      </div>
      <section class="comment-area">
  <div class="comment-wrapper">
    
    <div id="disqus_thread" class="article-comments"></div>
    <script>
      (function() {
          var d = document, s = d.createElement('script');
          s.src = '//cullaloe-gh.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
  </div>
</section> <!-- End Comment Area -->

    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-29333042-8', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->

	<!-- Scripts -->
  <!-- Search Js -->
<script src="/assets/js/search.js"></script>
  
</body>
</html>
