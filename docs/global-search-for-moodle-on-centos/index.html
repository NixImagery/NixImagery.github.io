<!DOCTYPE html>
<html lang="en">
    <head>
	<meta charset="utf-8">
	<title>Global Search for Moodle on Centos - @cullaloe | Tech, tales and imagery</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="@cullaloe | Tech, tales and imagery" property="og:site_name">
  
    <meta content="Global Search for Moodle on Centos" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="@cullaloe" property="og:description">
  
  
    <meta content="http://localhost:4000/global-search-for-moodle-on-centos/" property="og:url">
  
  
    <meta content="2017-09-06T15:54:42+01:00" property="article:published_time">
    <meta content="http://localhost:4000/about/" property="article:author">
  
  
    <meta content="http://localhost:4000/assets/img/Screen-Shot-2017-09-06-at-16.11.59.png" property="og:image">
  
  
    
  
  
    
    <meta content="Linux" property="article:tag">
    
    <meta content="Moodle" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@cullaloe">
    <meta name="twitter:creator" content="@cullaloe">
  
    <meta name="twitter:title" content="Global Search for Moodle on Centos">
  
  
    <meta name="twitter:url" content="http://localhost:4000/global-search-for-moodle-on-centos/">
  
  
    <meta name="twitter:description" content="@cullaloe">
  
  
    <meta name="twitter:image:src" content="http://localhost:4000/assets/img/Screen-Shot-2017-09-06-at-16.11.59.png">
  

	<meta name="description" content="">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicon/apple-touch-icon-144x144.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css">
	<link rel="stylesheet" href="/assets/css/search.css">
</head>

<body>

  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="cover-author-image">
        <a href="/"><img src="/assets/img/nick-hood.jpg" alt="Nick Hood"></a>
      </div>
      <div class="author-name"><a href="/about" target="_self" class="plain">Nick Hood</a></div>
      <p><a href="/tags" target="_self" class="plain">Tech, tales and imagery</a></p>
      <div class="search" id="js-search">
        <input type="text" placeholder="type to search..." class="search__input" id="js-search__input">
      </div>
    </div>
    <ul class="search__results" id="js-search__results"></ul>
</header> <!-- End Header -->
 
  <footer>
    <section class="contact">
      <h3 class="contact-title">Contact me</h3>
      <ul>
        
          <li><a href="https://twitter.com/cullaloe" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
        
        
          <li><a href="https://facebook.com/cullaloe" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
        
        
          <li class="github"><a href="http://github.com/cullaloe" target="_blank"><i class="fa fa-github"></i></a></li>
        
        
          <li class="linkedin"><a href="https://in.linkedin.com/in/cullaloe" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        
        
          <li class="email"><a href="mailto:nick@cullaloe.net"><i class="fa fa-envelope-o"></i></a></li>
        
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2020 &copy; Nick Hood</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->

<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    
    <div class="page-cover-image">
      <figure>
        <img class="page-image" src=/assets/img/Screen-Shot-2017-09-06-at-16.11.59.png alt="Global Search for Moodle on Centos">
        
      </figure>
    </div> <!-- End Page Cover Image -->
    
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">Global Search for Moodle on Centos</h1>
        <div class="page-date"><span>2017, Sep 06&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <p>My students are using a Moodle VLE to access resources and teaching materials and it became evident that some kind of global search function would help them find things quickly, especially later in the programme when they come to write their assignments.</p>

<p>I’m running Moodle on a CentOS 7.3 virtual private server with Plesk Onyx. The server hosts several other sites running WordPress, bespoke PHP and some other bits and pieces including the usual mail services. Some of the containers require the OS-standard PHP5.4 but a recent upgrade to Moodle 3.3 required me to switch the container to PHP 7.0.</p>

<p>Installing Global Search was a little tricky because of the multiple PHP versions running on the server, but I eventually figured it out to these key steps:</p>

<h2 id="install-the-solr-server">Install the Solr Server</h2>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> /opt
<span class="nv">$ </span>wget http://apache.mirrors.nublue.co.uk/lucene/solr/6.6.0/solr-6.6.0.tgz
<span class="nv">$ </span><span class="nb">tar </span>zxvf solr-6.6.0.tgz
<span class="nv">$ </span><span class="nb">cp </span>solr-6.6.0/bin/install_solr_service.sh <span class="nb">.</span>
<span class="nv">$ </span><span class="nb">rm</span> <span class="nt">-rf</span> solr-6.6.0
<span class="nv">$ </span>./install_solr_service.sh solr-6.6.0.tgz
<span class="nv">$ </span>chkconfig solr on
<span class="nv">$ </span>su - solr <span class="nt">-c</span> <span class="s2">"/opt/solr/bin/solr create_core -c moodle"</span>
</code></pre></div></div>
<p>You should be able to visit <code class="highlighter-rouge">http://your-domain.tld:8983</code> to verify the Solr server is running OK.</p>

<h2 id="secure-the-solr-server">Secure the Solr Server</h2>
<p>By default, Solr is open to the world. You might want to secure it by adding this at the end of <code class="highlighter-rouge">/opt/solr/server/etc/webdefault.xml</code></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;security-constraint&gt;</span>
      <span class="nt">&lt;web-resource-collection&gt;</span>
            <span class="nt">&lt;web-resource-name&gt;</span>Solr Administration<span class="nt">&lt;/web-resource-name&gt;</span>
            <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
      <span class="nt">&lt;/web-resource-collection&gt;</span>
      <span class="nt">&lt;auth-constraint&gt;</span>
            <span class="nt">&lt;role-name&gt;</span>solr-admin<span class="nt">&lt;/role-name&gt;</span>
      <span class="nt">&lt;/auth-constraint&gt;</span>
<span class="nt">&lt;/security-constraint&gt;</span>

<span class="nt">&lt;login-config&gt;</span>
      <span class="nt">&lt;auth-method&gt;</span>BASIC<span class="nt">&lt;/auth-method&gt;</span>
      <span class="nt">&lt;realm-name&gt;</span>Solr Administration<span class="nt">&lt;/realm-name&gt;</span>
<span class="nt">&lt;/login-config&gt;</span>
</code></pre></div></div>

<p>Create a file in the same directory called realm.properties containing your chosen authentication details (matching the role above) in a single line:</p>

<p><code class="highlighter-rouge">admin: password, solr-admin</code></p>

<p>Finally, add this just before the last line in jetty.xml in the same directory:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Call</span> <span class="na">name=</span><span class="s">"addBean"</span><span class="nt">&gt;</span>
 <span class="nt">&lt;Arg&gt;</span>
  <span class="nt">&lt;New</span> <span class="na">class=</span><span class="s">"org.eclipse.jetty.security.HashLoginService"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Set</span> <span class="na">name=</span><span class="s">"name"</span><span class="nt">&gt;</span>Solr Administration<span class="nt">&lt;/Set&gt;</span>
    <span class="nt">&lt;Set</span> <span class="na">name=</span><span class="s">"config"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;SystemProperty</span> <span class="na">name=</span><span class="s">"jetty.home"</span> <span class="na">default=</span><span class="s">"."</span><span class="nt">/&gt;</span>/etc/realm.properties<span class="nt">&lt;/Set&gt;</span>
    <span class="nt">&lt;Set</span> <span class="na">name=</span><span class="s">"refreshInterval"</span><span class="nt">&gt;&lt;/Set&gt;</span>
  <span class="nt">&lt;/New&gt;</span>
 <span class="nt">&lt;/Arg&gt;</span>
<span class="nt">&lt;/Call&gt;</span>
</code></pre></div></div>

<h2 id="install-the-php-solr-extension">Install the PHP Solr Extension</h2>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rpm <span class="nt">-Uvh</span> https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
<span class="nv">$ </span>rpm <span class="nt">-Uvh</span> https://mirror.webtatic.com/yum/el7/webtatic-release.rpm
<span class="nv">$ </span>yum <span class="nb">install </span>libxml2-devel pcre-devel libcurl-devel php70w-devel php70w-pear
</code></pre></div></div>

<p>You’ll need to build the extension using the right versions of phpize and php-config for your version of PHP, in my case, 7.0:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> /opt
<span class="nv">$ </span>curl <span class="nt">-O</span> https://pecl.php.net/get/solr-2.4.0.tgz
<span class="nv">$ </span><span class="nb">tar </span>zxvf solr-2.4.0.tgz
<span class="nv">$ </span><span class="nb">cd </span>solr-2.4.0/
<span class="nv">$ </span>../plesk/php/7.0/bin/phpize
<span class="nv">$ </span>./configure <span class="nt">--with-php-config</span><span class="o">=</span>/opt/plesk/php/7.0/bin/php-config
<span class="nv">$ </span>make
<span class="nv">$ </span>make <span class="nb">install</span>
<span class="nv">$ </span><span class="nb">cp</span> /opt/solr-2.4.0/modules/solr.so /opt/plesk/php/7.0/lib64/php/modules/
<span class="nv">$ </span><span class="nb">sudo </span>service httpd restart
</code></pre></div></div>

<p>Visit the Site administration / ▶︎ Plugins / ▶︎ Search / ▶︎ Manage global search page in your Moodle installation to configure, index and enable the Solr Search Engine.</p>

<p>I am impressed with how quickly this has been used and appreciated by the students.</p>

      <div class="page-footer">
        <div class="page-share">
          <a href="https://twitter.com/intent/tweet?text=Global Search for Moodle on Centos&url=http://localhost:4000/global-search-for-moodle-on-centos/" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a>
          <a href="https://facebook.com/sharer.php?u=http://localhost:4000/global-search-for-moodle-on-centos/" title="Share on Facebook" rel="nofollow" target="_blank">Facebook</a>
        </div>
        <div class="page-tag">
          
            <a href="/tags#Linux" class="tag">&#35; Linux</a>
          
            <a href="/tags#Moodle" class="tag">&#35; Moodle</a>
          
        </div>
      </div>
      <section class="comment-area">
  <div class="comment-wrapper">
    
    <div id="disqus_thread" class="article-comments"></div>
    <script>
      (function() {
          var d = document, s = d.createElement('script');
          s.src = '//cullaloe-gh.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
  </div>
</section> <!-- End Comment Area -->

    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-29333042-8', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->

	<!-- Scripts -->
  <!-- Search Js -->
<script src="/assets/js/search.js"></script>
  
</body>
</html>
